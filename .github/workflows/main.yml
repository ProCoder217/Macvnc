name: Try Enable VNC and Check Status

on:
  workflow_dispatch:

jobs:
  vnc-enable-test:
    runs-on: macos-latest # Using latest, but switch to macos-13 if you get a black screen

    steps:
    - name: ğŸ”‘ Setup Admin User
      run: |
        echo "Creating new admin user..."
        # We only create the new user. We do NOT touch the 'runner' or 'root' passwords to avoid crashing.
        # This command creates 'adminuser' with password 'SecretPass123!'
        sudo sysadminctl -addUser adminuser -fullName "Admin User" -password "SecretPass123!" -admin
        echo "âœ… Admin user created."

    - name: ğŸ› ï¸ Enable VNC (Screen Sharing)
      run: |
        echo "Trying to enable VNC..."
        
        # Enable Remote Management with a specific VNC password
        # -vncpw sets the password used to CONNECT to the VNC viewer
        sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -allowAccessFor -allUsers -privs -all \
          -clientopts -setvnclegacy -vnclegacy yes -setvncpw -vncpw "SecretPass123!" \
          -restart -agent -console
          
        echo "âœ… VNC Enabled."

    - name: ğŸ›‘ Disable Screen Lock & Sleep
      run: |
        # Crucial: Prevent the screen from locking so we don't need the 'runner' password to unlock it
        sudo systemsetup -setremotelogin on
        sudo systemsetup -setcomputersleep Never
        sudo systemsetup -setdisplaysleep Never
        # Disable screensaver defaults
        defaults write com.apple.screensaver askForPassword -int 0
        defaults write com.apple.screensaver idleTime -int 0

    - name: ğŸ” Check ARD Agent Status
      run: |
        echo "Checking com.apple.RemoteManagement status..."
        sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -status || true

    - name: ğŸ” Check if VNC port (5900) is listening
      run: |
        echo "Checking port 5900..."
        netstat -anv | grep 5900 || echo "Port 5900 not found in netstat."

    - name: ğŸš€ Start Bore (Keep Alive)
      run: |
        brew install bore-cli
        echo "----------------------------------------------------------------"
        echo "ğŸ”— CONNECT TO THE URL BELOW"
        echo "ğŸ”‘ VNC Password: SecretPass123!"
        echo "ğŸ‘¤ Admin User (for UI prompts): adminuser / SecretPass123!"
        echo "----------------------------------------------------------------"
        
        # Tunnels port 5900 to bore.pub
        bore local 5900 --to bore.pub
