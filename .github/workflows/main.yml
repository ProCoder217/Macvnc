name: Try Enable VNC and Check Status

on:
  workflow_dispatch:

jobs:
  vnc-enable-test:
    runs-on: macos-11  # Or macos-latest for newer images

    steps:
    - name: Attempt to enable VNC (Screen Sharing)
      run: |
        echo "ğŸ› ï¸ Trying to enable VNC..."
        sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on -clientopts -setvnclegacy -vnclegacy yes \
          -restart -agent -console -privs -all || true

    - name: Check ARD Agent Status
      run: |
        echo "ğŸ” Checking com.apple.RemoteManagement status (launchctl)..."
        launchctl list | grep -i remote || echo "ARD agent not running."
        echo "ğŸ” Checking system preferences for remote management:"
        sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -status || true

    - name: Check if VNC port (5900) is listening
      run: |
        echo "ğŸ” Checking if port 5900 is open/listening..."
        sudo lsof -iTCP:5900 -sTCP:LISTEN || echo "Port 5900 not listening."

    - name: Print enabled sharing services
      run: |
        echo "ğŸ–¥ï¸ Listing all enabled sharing services:"
        sudo systemsetup -listnetworkservices || true
        sudo systemsetup -getremotelogin || true
        sudo systemsetup -getremoteappleevents || true
