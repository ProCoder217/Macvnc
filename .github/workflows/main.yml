name: Try Enable VNC and Check Status

on:
  workflow_dispatch:

jobs:
  vnc-enable-test:
    runs-on: macos-latest # Note: macos-13 (Ventura) is often more stable for VNC than latest (Sonoma/Sequoia)

    steps:
    - name: üîë Setup Users & Passwords
      run: |
        echo "Creating new user and resetting passwords..."
        
        # 1. Create a new admin user named 'adminuser' with password 'SecretPass123!'
        sudo sysadminctl -addUser adminuser -fullName "Admin User" -password "SecretPass123!" -admin
        
        # 2. Set password for the default 'runner' user (Required to unlock screen)
        sudo dscl . -passwd /Users/runner "SecretPass123!"
        
        # 3. Set password for 'root' (As requested)
        sudo dscl . -passwd /Users/root "SecretPass123!"
        
        echo "‚úÖ Users configured."

    - name: üõ†Ô∏è Enable VNC (Screen Sharing)
      run: |
        echo "Trying to enable VNC..."
        
        # Enable Remote Management with a specific VNC password
        # We allow access for ALL users so your new 'adminuser' can login
        sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -allowAccessFor -allUsers -privs -all \
          -clientopts -setvnclegacy -vnclegacy yes -setvncpw -vncpw "SecretPass123!" \
          -restart -agent -console
          
        echo "‚úÖ VNC Enabled."

    - name: üõë Disable Screen Lock & Sleep
      run: |
        # Prevents the machine from going to sleep or locking the screen immediately
        sudo systemsetup -setremotelogin on
        sudo systemsetup -setcomputersleep Never
        sudo systemsetup -setdisplaysleep Never

    - name: üîé Check ARD Agent Status
      run: |
        echo "Checking com.apple.RemoteManagement status..."
        launchctl list | grep -i remote || echo "ARD agent not explicitly listed (normal if driven by launchd)."
        
        # Checking status via kickstart
        sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -status || true

    - name: üîç Check if VNC port (5900) is listening
      run: |
        echo "Checking port 5900..."
        # Using netstat as it's sometimes cleaner in logs than lsof
        netstat -anv | grep 5900 || echo "Port 5900 not found in netstat."
        sudo lsof -iTCP:5900 -sTCP:LISTEN || echo "Port 5900 not listening via lsof."

    - name: üñ•Ô∏è Print enabled sharing services
      run: |
        echo "Listing all enabled network services:"
        # FIXED: previous command was invalid
        networksetup -listallnetworkservices
        
        echo "Checking Remote Login status:"
        sudo systemsetup -getremotelogin

    - name: üöÄ Start Bore (Keep Alive)
      run: |
        # Installing bore to expose the VNC port
        brew install bore-cli
        echo "STARTING BORE... Connect to the URL below using a VNC Client."
        echo "VNC Password: SecretPass123!"
        echo "User: adminuser  (Password: SecretPass123!)"
        
        # Tunnels port 5900 to bore.pub
        bore local 5900 --to bore.pub
